{
    # INFO GLOBAL
    email gabrielvgonc@gmail.com

}

# --- NETMAKER CONFIG ---

https://dashboard.{$NM_DOMAIN} {
    header {
        Access-Control-Allow-Origin *
        Strict-Transport-Security "max-age=31536000;"
        X-XSS-Protection "1; mode=block"
        X-Frame-Options "SAMEORIGIN"
        X-Robots-Tag "none"
        -Server
    }

    reverse_proxy http://netmaker-ui {
        header_up X-Real-IP {http.request.header.CF-Connecting-IP}
        header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
    }
}

https://api.{$NM_DOMAIN} {
    reverse_proxy http://netmaker:8081 {
        header_up X-Real-IP {http.request.header.CF-Connecting-IP}
        header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
    }
}

broker.{$NM_DOMAIN} {
    @ws {
        header Connection Upgrade*
        header Upgrade websocket
    }

    reverse_proxy @ws mq:8883 {
        header_up X-Real-IP {http.request.header.CF-Connecting-IP}
        header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
    }
}



# Cloudflare DNS Challenge Wildcard 
(cloudflare_tls) {
    tls {
        dns cloudflare {env.CLOUDFLARE_AUTH_TOKEN}
    }
}

manage.gabriel-goncalves.com {
    import cloudflare_tls

    reverse_proxy 100.0.0.4:81 {
        header_up X-Real-IP {http.request.header.CF-Connecting-IP}
        header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
    }
}

# --- Reverse Proxy config ---
*.gabriel-goncalves.com, gabriel-goncalves.com {
    import cloudflare_tls

    @root host gabriel-goncalves.com
    handle @root {
        reverse_proxy 100.0.0.4:80 {
            header_up X-Real-IP {http.request.header.CF-Connecting-IP}
            header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
        }
    }

    handle {
        reverse_proxy 100.0.0.4:80 {
            header_up X-Real-IP {http.request.header.CF-Connecting-IP}
            header_up X-Forwarded-For {http.request.header.CF-Connecting-IP}
        }
    }
log {
    format json
}
}